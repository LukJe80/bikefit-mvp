<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bikefitting MVP (BOK + TYŁ) – DEMO v3.1</title>

  <style>
    :root{
      --bg:#0b0d10;
      --panel:#111418;
      --panel2:#0f1216;
      --line:#1d232b;
      --txt:#e8edf4;
      --muted:#a6b0bd;
      --accent:#ff6a00;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --chip:#1a2028;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      background: var(--bg);
      color: var(--txt);
    }

    .app{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:100vh;
    }

    .topbar{
      background: linear-gradient(180deg, rgba(255,106,0,.08), transparent);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      box-shadow: var(--shadow);
    }

    .title{
      font-weight:800;
      letter-spacing:.3px;
      margin-right:10px;
      white-space:nowrap;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: var(--chip);
      border:1px solid var(--line);
      color: var(--muted);
      font-size:13px;
      white-space:nowrap;
    }

    .chip b{ color:var(--txt); font-weight:700; }

    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: #151a20;
      color: var(--txt);
      padding:8px 12px;
      border-radius:12px;
      font-weight:700;
      transition:.15s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .btn:hover{ transform: translateY(-1px); border-color:#2b3340; }
    .btn:active{ transform: translateY(0px); }

    .btn.accent{ background: linear-gradient(180deg, rgba(255,106,0,.18), rgba(255,106,0,.07)); border-color: rgba(255,106,0,.35); }
    .btn.good{ background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.07)); border-color: rgba(34,197,94,.35); }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:180px;
    }
    .field label{
      font-size:12px;
      color: var(--muted);
    }
    .field input, .field select{
      background:#0f141a;
      border:1px solid var(--line);
      color: var(--txt);
      border-radius:12px;
      padding:8px 10px;
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.35fr 1fr;
      gap:10px;
      min-height:0;
      flex:1;
    }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .card h2{
      margin:0;
      padding:10px 12px;
      font-size:14px;
      letter-spacing:.2px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }

    .card-body{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      flex:1;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      min-height:0;
      flex:1;
    }

    .preview{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background:#000;
      min-height:240px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }

    /* --- FIX: stabilne rysowanie punktów (canvas ma stałe proporcje i nie "rozjeżdża" się przy zmianie rozmiaru) --- */
    .pointsCanvas{
      width: 100%;
      height: auto;
      aspect-ratio: 4 / 3;   /* bazowy układ demo jest ~800x600 */
      display:block;
      background:#000;
      border-radius:12px;
    }

    .hint{
      font-size:12px;
      color: var(--muted);
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .tab{
      cursor:pointer;
      border:1px solid var(--line);
      background: #0f141a;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
    }

    .tab.active{
      background: rgba(255,106,0,.12);
      border-color: rgba(255,106,0,.35);
      color: var(--txt);
    }

    .kv{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .kv .pill{
      background:#0f141a;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .kv .pill b{ color:var(--txt); }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:11px;
      color:#cbd5e1;
      background:#0b0f14;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      max-height:170px;
      overflow:auto;
      line-height:1.45;
    }

    .footer{
      color: var(--muted);
      font-size:12px;
      padding:6px 2px;
      text-align:right;
      opacity:.8;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title">Bikefitting MVP (BOK + TYŁ) – DEMO v3.1</div>

      <div class="row">
        <div class="field" style="min-width:200px">
          <label>Tryb</label>
          <select id="modeSel">
            <option value="HUB">HUB (laptop)</option>
            <option value="SIDE">SIDE only</option>
            <option value="REAR">REAR only</option>
          </select>
        </div>

        <div class="field">
          <label>WS URL</label>
          <input id="wsUrl" value="ws://localhost:8787/ws" />
        </div>

        <div class="field">
          <label>Token (opcjonalnie)</label>
          <input id="token" placeholder="..." />
        </div>

        <div class="row">
          <button id="btnDemo1" class="btn">Demo 1</button>
          <button id="btnDemo2" class="btn">Demo 2</button>
          <button id="btnDemo3" class="btn">Demo 3</button>
          <button id="btnStart" class="btn good">Start</button>
          <button id="btnStop" class="btn">Stop</button>
        </div>

        <div class="chip" id="chipStatus"><b>OFFLINE</b></div>
      </div>

      <div class="row">
        <div class="field" style="min-width:120px">
          <label>Wzrost (cm)</label>
          <input id="heightCm" type="number" value="175" />
        </div>
        <div class="field" style="min-width:120px">
          <label>Przekrok (cm)</label>
          <input id="inseamCm" type="number" value="82" />
        </div>

        <div class="chip"><b>Side:</b> <span id="sideState">—</span></div>
        <div class="chip"><b>Rear:</b> <span id="rearState">—</span></div>
        <div class="chip"><b>Tryb kinect:</b> <span id="kinectState">OFF</span></div>
      </div>

      <div class="kv">
        <div class="pill"><b>Kolano:</b> <span id="kneeAngle">—</span>°</div>
        <div class="pill"><b>Łokieć:</b> <span id="elbowAngle">—</span>°</div>
        <div class="pill"><b>Rodziing:</b> <span id="rocking">—</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Kamera</h2>
        <div class="card-body">
          <div class="tabs">
            <div class="tab active" data-tab="cam">Podgląd kamery</div>
            <div class="tab" data-tab="rule">RULER</div>
          </div>

          <div class="preview" id="camPreview">
            <div class="hint">Tu będzie podgląd (HUB/WS) albo statyczny placeholder w DEMO.</div>
          </div>

          <div class="preview" id="camPreview2" style="min-height:240px;">
            <div class="hint">Drugi podgląd / TYŁ (w DEMO puste).</div>
          </div>

          <div class="mono" id="logBox"></div>
        </div>
      </div>

      <div class="card">
        <h2>BOK – punkty + metryki</h2>
        <div class="card-body">
          <canvas id="sideCanvas" class="pointsCanvas"></canvas>
          <div class="mono" id="sideJson"></div>
        </div>
      </div>

      <div class="card">
        <h2>TYŁ – punkty + metryki</h2>
        <div class="card-body">
          <canvas id="rearCanvas" class="pointsCanvas"></canvas>
          <div class="mono" id="rearJson"></div>
        </div>
      </div>

      <div class="card">
        <h2>Notatki / status</h2>
        <div class="card-body">
          <div class="hint">
            DEMO: punkty są rysowane na canvasie. W trybie HUB będą pochodzić z serwera/WS.
          </div>
          <div class="mono" id="noteBox">
            • Kliknij DEMO 1/2/3 aby wczytać przykładowe punkty.<br>
            • Jeśli coś się rozjedzie – teraz naprawione: canvas ma stały rozmiar i przerysowuje się na resize.<br>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">v3.1 (canvas scaling fix)</div>
  </div>

  <script>
(() => {
  const els = {
    modeSel: document.getElementById("modeSel"),
    wsUrl: document.getElementById("wsUrl"),
    token: document.getElementById("token"),
    btnDemo1: document.getElementById("btnDemo1"),
    btnDemo2: document.getElementById("btnDemo2"),
    btnDemo3: document.getElementById("btnDemo3"),
    btnStart: document.getElementById("btnStart"),
    btnStop: document.getElementById("btnStop"),
    chipStatus: document.getElementById("chipStatus"),
    sideState: document.getElementById("sideState"),
    rearState: document.getElementById("rearState"),
    kinectState: document.getElementById("kinectState"),
    kneeAngle: document.getElementById("kneeAngle"),
    elbowAngle: document.getElementById("elbowAngle"),
    rocking: document.getElementById("rocking"),
    logBox: document.getElementById("logBox"),
    sideJson: document.getElementById("sideJson"),
    rearJson: document.getElementById("rearJson"),
    noteBox: document.getElementById("noteBox"),
    sideCanvas: document.getElementById("sideCanvas"),
    rearCanvas: document.getElementById("rearCanvas"),
  };

  // --- stan ---
  let ws = null;
  let wsState = "OFFLINE";
  let sidePoints = null;  // obiekt: {name:{x,y}, ...}
  let rearPoints = null;

  function log(msg){
    const t = new Date().toLocaleTimeString();
    els.logBox.innerHTML += `[${t}] ${msg}<br>`;
    els.logBox.scrollTop = els.logBox.scrollHeight;
  }

  function setStatus(text){
    wsState = text;
    els.chipStatus.innerHTML = `<b>${text}</b>`;
  }

  function normalizePointMap(obj){
    // zabezpieczenie
    if(!obj) return {};
    return obj;
  }

  function computeAngle(a, b, c){
    // kąt ABC w stopniach
    if(!a || !b || !c) return null;
    const abx = a.x - b.x, aby = a.y - b.y;
    const cbx = c.x - b.x, cby = c.y - b.y;
    const dot = abx*cbx + aby*cby;
    const mag1 = Math.hypot(abx, aby);
    const mag2 = Math.hypot(cbx, cby);
    if(mag1 === 0 || mag2 === 0) return null;
    const cos = Math.max(-1, Math.min(1, dot/(mag1*mag2)));
    return Math.round((Math.acos(cos) * 180/Math.PI) * 10) / 10;
  }

  function computeSideMetrics(p){
    // p: {shoulder, elbow, wrist, hip, knee, ankle}
    const elbow = computeAngle(p.shoulder, p.elbow, p.wrist);
    const knee  = computeAngle(p.hip, p.knee, p.ankle);
    return { elbow, knee };
  }

  function computeRearMetrics(p){
    // placeholder – w przyszłości: rocking, kolano L/R itd.
    return { rocking: null };
  }

  function drawPointsTo(canvas, points, title){
    // --- FIX: dopasuj rozmiar canvas do tego co widać na ekranie (CSS) ---
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const cssW = Math.max(1, rect.width);
    const cssH = Math.max(1, rect.height);

    const pxW = Math.max(1, Math.round(cssW * dpr));
    const pxH = Math.max(1, Math.round(cssH * dpr));

    if (canvas.width !== pxW || canvas.height !== pxH){
      canvas.width = pxW;
      canvas.height = pxH;
    }

    const ctx = canvas.getContext("2d");
    // rysujemy w jednostkach CSS (nie w pikselach urządzenia)
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, cssW, cssH);

    // tło (czarne jak w podglądach)
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, cssW, cssH);

    // bazowe wymiary dla "demo" (stare współrzędne są w okolicach 800x600)
    const BASE_W = 800;
    const BASE_H = 600;
    const sx = cssW / BASE_W;
    const sy = cssH / BASE_H;

    // tytuł
    if(title){
      ctx.fillStyle = "#fff";
      ctx.font = "16px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial";
      ctx.fillText(title, 12, 26);
    }

    // Ujednolicenie formatu punktów:
    // - czasem jest Array: [{name,x,y}, ...]
    // - a czasem jest Object: { shoulder:{x,y}, elbow:{x,y}, ... }
    const list = Array.isArray(points)
      ? points.map(p => ({ name: p.name, x: p.x, y: p.y }))
      : Object.entries(points || {}).map(([name, p]) => ({ name, x: p.x, y: p.y }));

    // punkty
    for (const p of list){
      if (p.x == null || p.y == null) continue;

      // Jeśli punkty są znormalizowane (0..1) – rysuj proporcjonalnie.
      // Jeśli są w "starych pikselach" (np. 400, 300) – przeskaluj z BASE_W/BASE_H.
      const isNormalized = (p.x <= 1.5 && p.y <= 1.5);
      const x = isNormalized ? (p.x * cssW) : (p.x * sx);
      const y = isNormalized ? (p.y * cssH) : (p.y * sy);

      // kółko
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x, y, 8, 0, Math.PI * 2);
      ctx.stroke();

      // opis
      ctx.fillStyle = "#fff";
      ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial";
      ctx.fillText(p.name, x + 12, y + 5);
    }
  }

  function updateHubUI(){
    const sp = normalizePointMap(sidePoints);
    const rp = normalizePointMap(rearPoints);

    // punkty
    drawPointsTo(els.sideCanvas, sp, "BOK (punkty)");
    drawPointsTo(els.rearCanvas, rp, "TYŁ (punkty)");

    // json
    els.sideJson.textContent = JSON.stringify(sp, null, 2);
    els.rearJson.textContent = JSON.stringify(rp, null, 2);

    // metryki
    const m1 = computeSideMetrics(sp);
    const m2 = computeRearMetrics(rp);

    els.elbowAngle.textContent = (m1.elbow ?? "—");
    els.kneeAngle.textContent  = (m1.knee ?? "—");
    els.rocking.textContent    = (m2.rocking ?? "—");

    els.sideState.textContent = Object.keys(sp).length ? "OK" : "—";
    els.rearState.textContent = Object.keys(rp).length ? "OK" : "—";
  }

  // --- DEMO dane ---
  const DEMOS = {
    1: {
      side: {
        shoulder:{x:520,y:180},
        elbow:{x:470,y:240},
        wrist:{x:420,y:270},
        hip:{x:540,y:280},
        knee:{x:620,y:390},
        ankle:{x:640,y:510},
      },
      rear: {
        l_shoulder:{x:360,y:260},
        r_shoulder:{x:420,y:260},
        l_hip:{x:360,y:360},
        r_hip:{x:420,y:360},
      }
    },
    2: {
      side: {
        shoulder:{x:540,y:170},
        elbow:{x:500,y:235},
        wrist:{x:450,y:275},
        hip:{x:560,y:300},
        knee:{x:640,y:420},
        ankle:{x:660,y:520},
      },
      rear: {
        l_shoulder:{x:350,y:250},
        r_shoulder:{x:430,y:250},
        l_hip:{x:350,y:370},
        r_hip:{x:430,y:370},
      }
    },
    3: {
      side: {
        shoulder:{x:500,y:170},
        elbow:{x:455,y:235},
        wrist:{x:410,y:270},
        hip:{x:520,y:305},
        knee:{x:585,y:430},
        ankle:{x:610,y:540},
      },
      rear: {
        l_shoulder:{x:340,y:250},
        r_shoulder:{x:440,y:250},
        l_hip:{x:340,y:380},
        r_hip:{x:440,y:380},
      }
    }
  };

  function loadDemo(n){
    const d = DEMOS[n];
    sidePoints = structuredClone(d.side);
    rearPoints = structuredClone(d.rear);
    log(`Wczytano DEMO ${n}`);
    updateHubUI();
  }

  function wsConnect(){
    const url = els.wsUrl.value.trim();
    if(!url){
      log("Brak WS URL");
      return;
    }
    setStatus("CONNECTING");
    log("Łączę WS: " + url);

    try{
      ws = new WebSocket(url);
    }catch(e){
      setStatus("OFFLINE");
      log("Błąd WebSocket: " + e.message);
      return;
    }

    ws.onopen = () => {
      setStatus("ONLINE");
      log("WS: połączono");
      const tk = els.token.value.trim();
      if(tk){
        ws.send(JSON.stringify({type:"auth", token: tk}));
        log("WS: wysłano auth token");
      }
    };

    ws.onclose = () => {
      setStatus("OFFLINE");
      log("WS: rozłączono");
      ws = null;
    };

    ws.onerror = () => {
      log("WS: błąd");
    };

    ws.onmessage = (ev) => {
      try{
        const msg = JSON.parse(ev.data);
        if(msg.type === "sidePoints"){
          sidePoints = msg.points || msg;
          updateHubUI();
        } else if(msg.type === "rearPoints"){
          rearPoints = msg.points || msg;
          updateHubUI();
        } else if(msg.type === "kinect"){
          els.kinectState.textContent = msg.state ? "ON" : "OFF";
        } else {
          // dowolne
        }
      }catch(e){
        // ignoruj
      }
    };
  }

  function wsDisconnect(){
    if(ws){
      ws.close();
      ws = null;
    }
    setStatus("OFFLINE");
  }

  // --- eventy ---
  els.btnDemo1.addEventListener("click", () => loadDemo(1));
  els.btnDemo2.addEventListener("click", () => loadDemo(2));
  els.btnDemo3.addEventListener("click", () => loadDemo(3));

  els.btnStart.addEventListener("click", () => {
    if(els.modeSel.value === "HUB"){
      wsConnect();
    }else{
      log("Tryb nie-HUB: Start pominięty (DEMO lokalne).");
    }
  });

  els.btnStop.addEventListener("click", () => {
    wsDisconnect();
  });

  // start
  setStatus("OFFLINE");
  loadDemo(1);

  // --- FIX: przy zmianie rozmiaru okna przerysuj canvasy (żeby punkty nie "uciekały") ---
  let _resizeT = null;
  window.addEventListener("resize", () => {
    clearTimeout(_resizeT);
    _resizeT = setTimeout(() => {
      updateHubUI();
    }, 100);
  });

})();
  </script>
</body>
</html>
