<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bikefit LIVE – 1 kamera (bok)</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#020617">

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <style>
    /* ✅ MOTYW 1:1 jak w orders.html */
    :root{
      --accent:#2563eb;
      --accentHover:#1d4ed8;
      --bg:#020617;
      --text:#e5e7eb;
      --panel: rgba(255,255,255,0.05);
      --panelBorder: rgba(255,255,255,0.10);
      --muted: rgba(229,231,235,0.7);
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .page{ max-width:1280px; margin:0 auto; padding:14px; }

    .top{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .title{
      font-size:18px;
      color:var(--accent);
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .bar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.10);
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); border-color:rgba(37,99,235,0.45); }
    .btn.primary{
      border-color:rgba(37,99,235,0.75);
      box-shadow:0 0 0 3px rgba(37,99,235,0.18);
    }
    .btn.danger:hover{ border-color:rgba(239,68,68,0.55); }

    .pill{
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.35);
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .dot{ width:10px; height:10px; border-radius:50%; background:#ef4444; }
    .dot.on{ background:#4ade80; }

    .grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--panel);
      border:1px solid var(--panelBorder);
      border-radius:16px;
      padding:14px;
    }

    .h{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.3px;
      text-transform:uppercase;
      color:#93c5fd;
    }

    .videoWrap{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
    }
    video,canvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
    }

    .instr{
      border:1px solid rgba(37,99,235,0.35);
      background:rgba(37,99,235,0.08);
      border-radius:14px;
      padding:14px;
    }
    .instr h3{
      margin:0 0 6px 0;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:#93c5fd;
    }
    .instr .big{ font-size:24px; font-weight:900; margin:0 0 6px 0; color:var(--text); }
    .small{ color:var(--muted); font-size:13px; line-height:1.35; }

    .kpis{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }
    @media (max-width: 980px){ .kpis{ grid-template-columns:1fr; } }
    .kpi{ padding:12px; }
    .kpi .label{ font-size:12px; text-transform:uppercase; letter-spacing:.5px; color:#93c5fd; font-weight:900; }
    .kpi .val{ font-size:26px; font-weight:900; margin-top:6px; }
    .kpi .desc{ margin-top:6px; color:var(--muted); font-size:13px; }

    .debug{
      margin-top:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      white-space:pre-wrap;
      padding:12px;
    }
  </style>
</head>
<body>
<script>
/* ✅ Gate dostępu: jeśli brak sesji -> wróć do logowania */
const AUTH_KEY = "bikefit_auth";
function isAuthed(){
  try{
    const raw = localStorage.getItem(AUTH_KEY);
    if(!raw) return false;
    const obj = JSON.parse(raw);
    return obj && obj.exp && obj.exp > Date.now();
  }catch(e){ return false; }
}
if(!isAuthed()){
  location.replace("/");
}
</script>

<div class="page">
  <div class="top">
    <div class="title">Bikefit LIVE • 1 kamera (bok)</div>

    <div class="bar">
      <button id="logoutBtn" class="btn danger">Wyloguj</button>
      <button id="startBtn" class="btn primary">Start kamery</button>
      <button id="stopBtn" class="btn">Stop</button>

      <div class="pill">
        <span id="dot" class="dot"></span>
        Status: <span id="status">OFF</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="h">Podgląd + punkty</div>

      <div class="videoWrap">
        <video id="video" playsinline muted></video>
        <canvas id="canvas"></canvas>
      </div>

      <div class="small" style="margin-top:8px">
        Jeśli obraz czarny: Chrome → kłódka → Kamera: <b>Zezwalaj</b> + zamknij Teams/Zoom/OBS.
      </div>
    </div>

    <div class="card">
      <div class="h">Instruktor</div>

      <div class="instr">
        <h3>Wskazówka</h3>
        <div id="hintTitle" class="big">Uruchom kamerę</div>
        <div id="hintText" class="small">Kliknij „Start kamery”.</div>
      </div>

      <div class="kpis">
        <div class="card kpi">
          <div class="label">Kąt kolana</div>
          <div id="kneeVal" class="val">—</div>
          <div class="desc">Do oceny wysokości siodła.</div>
        </div>

        <div class="card kpi">
          <div class="label">Kąt łokcia</div>
          <div id="elbowVal" class="val">—</div>
          <div class="desc">Do oceny reach / mostka.</div>
        </div>

        <div class="card kpi">
          <div class="label">Kąt tułowia</div>
          <div id="torsoVal" class="val">—</div>
          <div class="desc">Do oceny drop / wysokości kokpitu.</div>
        </div>

        <div class="card kpi">
          <div class="label">Stabilność</div>
          <div id="stabVal" class="val">—</div>
          <div class="desc">Pewność punktów (widoczność).</div>
        </div>
      </div>

      <div class="small" style="margin-top:10px">Debug:</div>
      <div id="debug" class="card debug">DBG: gotowe.</div>
    </div>
  </div>
</div>

<script>
/* ============ Logout (naprawione) ============ */
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem(AUTH_KEY);
  location.replace("/");
});

/* ============ UI helpers ============ */
const $ = (id) => document.getElementById(id);
const statusEl = $("status");
const dotEl = $("dot");
const debugEl = $("debug");
const hintTitle = $("hintTitle");
const hintText = $("hintText");

function dbg(msg){ debugEl.textContent = "DBG: " + msg; }
function setStatus(txt, on){
  statusEl.textContent = txt;
  dotEl.classList.toggle("on", !!on);
}
function setHint(title, text){
  hintTitle.textContent = title;
  hintText.textContent = text;
}

/* ============ Math helpers ============ */
function angleABC(a,b,c){
  const abx=a.x-b.x, aby=a.y-b.y;
  const cbx=c.x-b.x, cby=c.y-b.y;
  const dot=abx*cbx+aby*cby;
  const lab=Math.hypot(abx,aby);
  const lcb=Math.hypot(cbx,cby);
  if(lab===0||lcb===0) return null;
  let cos=dot/(lab*lcb);
  cos=Math.max(-1,Math.min(1,cos));
  return Math.acos(cos)*180/Math.PI;
}
function fmtDeg(x){ return (x==null||Number.isNaN(x)) ? "—" : (Math.round(x)+"°"); }

/* ============ MediaPipe Pose ============ */
let camera=null;
let pose=null;
let stream=null;

const video=$("video");
const canvas=$("canvas");
const ctx=canvas.getContext("2d");

function resizeCanvasToVideo(){
  const w=video.videoWidth||1280;
  const h=video.videoHeight||720;
  canvas.width=w; canvas.height=h;
}

function draw(results){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(results.image){
    ctx.drawImage(results.image,0,0,canvas.width,canvas.height);
  }
  if(results.poseLandmarks){
    window.drawConnectors(ctx, results.poseLandmarks, window.POSE_CONNECTIONS,
      { color: "rgba(255,255,255,0.35)", lineWidth: 3 });
    window.drawLandmarks(ctx, results.poseLandmarks,
      { color: "rgba(255,255,255,0.95)", lineWidth: 2, radius: 4 });
  }
  ctx.restore();
}

function computeMetrics(results){
  const lm=results.poseLandmarks;
  if(!lm) return;

  const hip=lm[24], knee=lm[26], ankle=lm[28];
  const shoulder=lm[12], elbow=lm[14], wrist=lm[16];

  const kneeAng=angleABC(hip,knee,ankle);
  const elbowAng=angleABC(shoulder,elbow,wrist);

  let torsoAng=null;
  if(hip && shoulder){
    const a={x:hip.x, y:hip.y-1};
    torsoAng=angleABC(a, hip, shoulder);
  }

  $("kneeVal").textContent=fmtDeg(kneeAng);
  $("elbowVal").textContent=fmtDeg(elbowAng);
  $("torsoVal").textContent=fmtDeg(torsoAng);

  const vis=[hip,knee,ankle,shoulder,elbow,wrist].map(p=>p?.visibility??0);
  const avg=vis.reduce((s,v)=>s+v,0)/vis.length;
  const stab=Math.round(avg*100);
  $("stabVal").textContent = (isFinite(stab)?(stab+"%"):"—");

  if(kneeAng!=null){
    if(kneeAng < 135){
      setHint("Kolano za mocno zgięte", "Siodło może być za nisko. Podnieś o 3–5 mm i sprawdź ponownie.");
    }else if(kneeAng > 155){
      setHint("Kolano za proste", "Siodło może być za wysoko. Opuść o 3–5 mm i sprawdź ponownie.");
    }else{
      setHint("Kąt kolana wygląda OK", "Następnie rozbudujemy instruktor o reach i stabilność.");
    }
  }
}

async function initPose(){
  pose = new window.Pose({
    locateFile: (file) => "https://cdn.jsdelivr.net/npm/@mediapipe/pose/" + file
  });

  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults((results) => {
    if(video.videoWidth && canvas.width === 0) resizeCanvasToVideo();
    draw(results);
    computeMetrics(results);
  });
}

async function startCamera(){
  try{
    setStatus("START...", false);
    setHint("Łączę kamerę", "Przeglądarka może zapytać o zgodę.");
    dbg("start...");

    if(!pose) await initPose();

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:"user", width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });

    video.srcObject=stream;
    await video.play();
    resizeCanvasToVideo();

    camera = new window.Camera(video, {
      onFrame: async () => { await pose.send({ image: video }); }
    });
    camera.start();

    setStatus("ON", true);
    setHint("Analizuję", "Punkty powinny pojawić się po 1–2 sekundach.");
    dbg("kamera OK");
  }catch(e){
    console.error(e);
    dbg((e && e.message) ? e.message : String(e));
    setStatus("OFF", false);
    setHint("Błąd kamery", "Sprawdź kłódkę (kamera: zezwalaj), zamknij Teams/Zoom i odśwież.");
  }
}

function stopCamera(){
  try{ if(camera) camera.stop(); }catch(_){}
  camera=null;

  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream=null;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  setStatus("OFF", false);
  setHint("Zatrzymano", "Kliknij „Start kamery”, aby uruchomić ponownie.");
  dbg("stop");
}

$("startBtn").addEventListener("click", startCamera);
$("stopBtn").addEventListener("click", stopCamera);

if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
  setHint("Brak wsparcia", "Ta przeglądarka nie obsługuje kamery. Użyj Chrome/Edge.");
}
</script>
</body>
</html>
