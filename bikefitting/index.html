<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bikefit MVP (BOK + TYŁ) – DEMO v2</title>
<style>
  body{margin:0;font-family:system-ui,Arial;background:#0b0b0c;color:#fff}
  header{padding:12px 16px;background:#141416;border-bottom:1px solid #26262a}
  h1{margin:0 0 8px 0;font-size:18px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
  input,select,button{padding:8px;border-radius:10px;border:1px solid #333;background:#0f0f11;color:#fff}
  input{width:150px}
  button{cursor:pointer}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #333;background:#0f0f11}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
  .card{background:#141416;border:1px solid #26262a;border-radius:12px;padding:12px}
  .full{grid-column:1/-1}
  video,canvas{width:100%;border-radius:12px;background:#000;margin-top:8px}
  pre{white-space:pre-wrap;background:#0f0f11;padding:8px;border-radius:10px;border:1px solid #26262a;max-height:220px;overflow:auto}
  #reco .item{padding:10px;border:1px solid #2a2a2f;border-radius:12px;margin:8px 0;background:#101014}
  #reco .bad{border-color:#6a2a2a}
  #reco .warn{border-color:#6a5a2a}
  #reco .ok{border-color:#2a6a3a}
  small{opacity:.8}
  .muted{opacity:.75}
  .kpi{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .kpi .pill{border-color:#2a2a2f}
  .sessionBar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .sessionList{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .snap{border:1px solid #2a2a2f;border-radius:12px;background:#101014;padding:10px}
  .snapHeader{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .tag{padding:4px 8px;border-radius:999px;border:1px solid #2a2a2f;background:#0f0f11;font-size:12px}

  .demoGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  .demoBox{border:1px solid #2a2a2f;border-radius:12px;background:#101014;padding:10px}
  .demoBox h3{margin:0 0 8px 0;font-size:14px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<header>
  <h1>Bikefit MVP (BOK + TYŁ) – DEMO v2</h1>

  <div class="row">
    <label>Tryb:</label>
    <select id="mode">
      <option value="hub">HUB (Laptop)</option>
      <option value="cam_side">CAM – BOK (Telefon)</option>
      <option value="cam_rear">CAM – TYŁ (Telefon)</option>
      <option value="demo">DEMO (bez kamer)</option>
    </select>
    <span id="status" class="pill">OFFLINE</span>
    <span id="cams" class="pill">SIDE: - | REAR: -</span>
  </div>

  <div class="row">
    <label>Room:</label><input id="room" value="default"/>
    <label>WS URL:</label><input id="wsUrl" placeholder="ws://IP:8181"/>
    <button id="btnConnect">Połącz</button>
    <button id="btnStart">Start</button>
    <button id="btnStop">Stop</button>
  </div>

  <div class="row">
    <label>Styl:</label>
    <select id="style">
      <option value="road">Szosa</option>
      <option value="mtb">MTB</option>
    </select>
    <label>Wzrost (cm):</label><input id="height" type="number" value="175"/>
    <label>Przekrok (cm):</label><input id="inseam" type="number" value="82"/>
    <small>Tip: przekrok = od kroku do ziemi (książka + ściana).</small>
  </div>

  <div class="kpi">
    <span class="pill" id="kpiKnee">Kolano: -</span>
    <span class="pill" id="kpiElbow">Łokieć: -</span>
    <span class="pill" id="kpiRock">Rocking: -</span>
  </div>
</header>

<main class="grid">
  <section class="card" id="cardCam">
    <h2 id="camTitle">Kamera</h2>
    <div class="row">
      <button id="btnSwitchCam">Przełącz kamerę</button>
      <span class="pill" id="rolePill">ROLE: -</span>
    </div>
    <video id="v" playsinline autoplay muted></video>
    <canvas id="c"></canvas>
    <pre id="camOut"></pre>
  </section>

  <section class="card" id="cardSide">
    <h2>BOK – metryki</h2>
    <canvas id="sideCanvas"></canvas>
    <pre id="sideOut"></pre>
  </section>

  <section class="card" id="cardRear">
    <h2>TYŁ – metryki</h2>
    <canvas id="rearCanvas"></canvas>
    <pre id="rearOut"></pre>
  </section>

  <section class="card full">
    <h2>Rekomendacje</h2>
    <div id="reco"></div>
    <small class="muted">
      Uwaga: v1.1 to rekomendacje krokowe + re-test.
    </small>
  </section>

  <section class="card full">
    <h2>Sesja</h2>
    <div class="sessionBar">
      <button id="btnNewSession">Nowa sesja</button>
      <button id="btnSnap">Zapisz pomiar (SNAP)</button>
      <button id="btnExport">Eksport JSON</button>
      <span class="pill" id="sessionInfo">SNAP: 0</span>
      <span class="pill" id="sessionId">ID: -</span>
    </div>
    <div id="sessionList" class="sessionList"></div>
    <small class="muted">
      Eksport zapisuje snapshoty metryk + rekomendacje. W przyszłości dołożymy PDF.
    </small>
  </section>

  <!-- DEMO v2 -->
  <section class="card full" id="cardDemo">
    <h2>DEMO v2 – scenariusze + PRZED / PO</h2>

    <div class="row">
      <label>Scenariusz:</label>
      <select id="demoScenario">
        <option value="ok">OK (referencja)</option>
        <option value="saddle_high">Siodło za wysoko</option>
        <option value="saddle_low">Siodło za nisko</option>
        <option value="reach_long">Za długi reach</option>
        <option value="pelvis_asym">Asymetria miednicy</option>
        <option value="shoulder_asym">Asymetria barków</option>
        <option value="rocking_high">Mocny rocking</option>
      </select>
      <button id="btnDemoLoad">Wczytaj</button>

      <span class="pill" id="demoStatePill">TRYB: LIVE</span>
      <button id="btnSetBefore">Ustaw jako PRZED</button>
      <button id="btnSetAfter">Ustaw jako PO</button>
      <button id="btnClearBeforeAfter">Wyczyść PRZED/PO</button>
    </div>

    <div class="row">
      <label>Korekty DEMO:</label>
      <button id="btnAdjSaddleDown">Siodło -5mm</button>
      <button id="btnAdjSaddleUp">Siodło +5mm</button>
      <button id="btnAdjReachShorter">Reach -10mm</button>
      <button id="btnAdjReachLonger">Reach +10mm</button>
      <button id="btnAdjReduceRock">Zredukuj rocking</button>
      <small class="muted">To są symulacje do testu logiki (nie fizyka 1:1).</small>
    </div>

    <div class="demoGrid">
      <div class="demoBox">
        <h3>PRZED – metryki</h3>
        <pre class="mono" id="demoBeforeOut">brak</pre>
      </div>
      <div class="demoBox">
        <h3>PO – metryki</h3>
        <pre class="mono" id="demoAfterOut">brak</pre>
      </div>
      <div class="demoBox">
        <h3>Różnice (PO - PRZED)</h3>
        <pre class="mono" id="demoDeltaOut">brak</pre>
      </div>
      <div class="demoBox">
        <h3>Aktualne punkty (LIVE)</h3>
        <pre class="mono" id="demoJson">-</pre>
      </div>
    </div>
  </section>
</main>

<script>
/** =========================
 *  HSV + markery (do dopasowania pod Twoje naklejki)
 *  ========================= */
const HSV = {
  neonGreen: { h1: 45,  h2: 95,  s: 120, v: 80 },
  cyan:      { h1: 170, h2: 210, s: 120, v: 80 },
  orange:    { h1: 15,  h2: 40,  s: 120, v: 80 },
  yellow:    { h1: 40,  h2: 70,  s: 120, v: 80 },
  purple:    { h1: 250, h2: 300, s: 110, v: 70 },
  pinkWrap:  { h1: 300, h2: 360, s: 120, v: 80, wrap: true, h3: 0, h4: 20 }
};

function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  const d=max-min;
  let h=0;
  if(d!==0){
    if(max===r) h=((g-b)/d)%6;
    else if(max===g) h=(b-r)/d+2;
    else h=(r-g)/d+4;
    h*=60; if(h<0) h+=360;
  }
  const s=max===0?0:d/max;
  const v=max;
  return {h, s:s*255, v:v*255};
}
function inPreset(hsv,p){
  if(hsv.s<p.s || hsv.v<p.v) return false;
  if(p.wrap){
    return (hsv.h>=p.h1 && hsv.h<=p.h2) || (hsv.h>=p.h3 && hsv.h<=p.h4);
  }
  return hsv.h>=p.h1 && hsv.h<=p.h2;
}
function findCentroid(imageData, w, h, preset){
  const data=imageData.data;
  let sx=0, sy=0, c=0;
  for(let y=0;y<h;y+=2){
    for(let x=0;x<w;x+=2){
      const i=(y*w+x)*4;
      const hsv=rgbToHsv(data[i],data[i+1],data[i+2]);
      if(inPreset(hsv,preset)){ sx+=x; sy+=y; c++; }
    }
  }
  if(c<60) return null;
  return {x:sx/c, y:sy/c, n:c};
}
function angle3(a,b,c){
  if(!a||!b||!c) return NaN;
  const ba={x:a.x-b.x, y:a.y-b.y};
  const bc={x:c.x-b.x, y:c.y-b.y};
  const dot=ba.x*bc.x+ba.y*bc.y;
  const nba=Math.hypot(ba.x,ba.y);
  const nbc=Math.hypot(bc.x,bc.y);
  const cos=dot/(nba*nbc+1e-9);
  const v=Math.max(-1,Math.min(1,cos));
  return Math.acos(v)*180/Math.PI;
}
function drawDot(ctx,p,label){
  if(!p) return;
  ctx.beginPath(); ctx.arc(p.x,p.y,8,0,Math.PI*2); ctx.stroke();
  ctx.fillText(label,p.x+10,p.y);
}
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

/** =========================
 *  Reco v1.1
 *  ========================= */
function makeTargets(style){
  return style==="road"
    ? { kneeBDP: [145, 160], elbow: [150, 175], rockingMax: 0.035 }
    : { kneeBDP: [140, 158], elbow: [155, 178], rockingMax: 0.045 };
}
function stepMmFromDelta(deltaDeg){
  const ad = Math.abs(deltaDeg);
  if(ad < 2) return 0;
  if(ad < 4) return 3;
  if(ad < 7) return 5;
  if(ad < 10) return 10;
  return 15;
}
function saddleStarterFromInseam(inseam_cm){
  if(!inseam_cm || inseam_cm<=0) return null;
  return 0.883 * inseam_cm;
}
function recommendations(profile, sideMetrics, rearMetrics){
  const t = makeTargets(profile.style);
  const out = [];

  const starter = saddleStarterFromInseam(profile.inseam_cm||0);
  out.push({
    lvl:"ok",
    title:"Profil",
    why:`Styl: ${profile.style.toUpperCase()}, wzrost: ${profile.height_cm||"-"} cm, przekrok: ${profile.inseam_cm||"-"} cm.`,
    do: starter ? `Punkt startowy (orientacyjnie): wysokość siodła ~ ${starter.toFixed(1)} cm (0.883).` : `Dodaj przekrok, a policzę punkt startowy siodła.`
  });

  // siodło
  if(Number.isFinite(sideMetrics.knee)){
    const knee = sideMetrics.knee;
    const deltaHigh = knee - t.kneeBDP[1];
    const deltaLow  = t.kneeBDP[0] - knee;
    const mmHigh = stepMmFromDelta(deltaHigh) || 5;
    const mmLow  = stepMmFromDelta(deltaLow)  || 5;

    if(knee > t.kneeBDP[1] && Number.isFinite(rearMetrics.rocking) && rearMetrics.rocking > t.rockingMax){
      out.push({lvl:"bad", title:"Siodło prawdopodobnie za wysoko",
        why:`Kolano ~ ${knee.toFixed(1)}° (cel: ${t.kneeBDP[0]}–${t.kneeBDP[1]}°) + rocking ${rearMetrics.rocking.toFixed(3)} (wysoki).`,
        do:`Obniż siodło o ${mmHigh} mm i re-test.`});
    } else if(knee > t.kneeBDP[1]){
      out.push({lvl:"warn", title:"Możliwe: siodło za wysoko",
        why:`Kolano ~ ${knee.toFixed(1)}° (powyżej ${t.kneeBDP[1]}°).`,
        do:`Test: obniż o ${mmHigh} mm i re-test.`});
    } else if(knee < t.kneeBDP[0]){
      out.push({lvl:"warn", title:"Możliwe: siodło za nisko",
        why:`Kolano ~ ${knee.toFixed(1)}° (poniżej ${t.kneeBDP[0]}°).`,
        do:`Test: podnieś o ${mmLow} mm i re-test.`});
    } else {
      out.push({lvl:"ok", title:"Wysokość siodła wygląda OK (wg kolana)",
        why:`Kolano ~ ${knee.toFixed(1)}° w zakresie.`,
        do:`OK. Dalej przód + stabilność.`});
    }
  } else {
    out.push({lvl:"warn", title:"Brak metryki kolana (BOK)",
      why:"Nie wykryto hip/knee/ankle.", do:"Sprawdź markery/światło."});
  }

  // reach
  if(Number.isFinite(sideMetrics.elbow)){
    const e = sideMetrics.elbow;
    if(e > t.elbow[1]){
      out.push({lvl:"warn", title:"Możliwie za duży reach",
        why:`Łokieć ~ ${e.toFixed(1)}° (powyżej ${t.elbow[1]}°).`,
        do:`Test: krótszy mostek o 10 mm lub +5–10 mm podkładek. Re-test.`});
    } else if(e < t.elbow[0]){
      out.push({lvl:"warn", title:"Pozycja mocno zebrana",
        why:`Łokieć ~ ${e.toFixed(1)}° (poniżej ${t.elbow[0]}°).`,
        do:`Jeśli nie aero: dłuższy mostek +10 mm. Re-test.`});
    } else {
      out.push({lvl:"ok", title:"Łokieć wygląda OK", why:`Łokieć ~ ${e.toFixed(1)}° w zakresie.`, do:"OK."});
    }
  }

  // rocking
  if(Number.isFinite(rearMetrics.rocking)){
    if(rearMetrics.rocking > t.rockingMax){
      out.push({lvl:"warn", title:"Rocking miednicy podwyższony",
        why:`Rocking ~ ${rearMetrics.rocking.toFixed(3)} (powyżej ${t.rockingMax}).`,
        do:`Najczęściej: minimalnie za wysoko siodło lub zbyt agresywny przód. Testuj 1 zmianę.`});
    } else {
      out.push({lvl:"ok", title:"Stabilność miednicy OK",
        why:`Rocking ~ ${rearMetrics.rocking.toFixed(3)} (<= ${t.rockingMax}).`,
        do:"OK."});
    }
  }

  out.push({lvl:"ok", title:"Setback / sztyca (kolejna wersja)",
    why:"W v2 dołożymy KOPS (kolano względem osi pedału) i wtedy setback/offset będą precyzyjniejsze.",
    do:"Na teraz trzymamy się: wysokość siodła + reach + stabilność."});

  return out;
}

/** =========================
 *  UI + WebSocket + metryki
 *  ========================= */
const els = {
  mode: document.getElementById("mode"),
  status: document.getElementById("status"),
  cams: document.getElementById("cams"),
  room: document.getElementById("room"),
  wsUrl: document.getElementById("wsUrl"),
  btnConnect: document.getElementById("btnConnect"),
  btnStart: document.getElementById("btnStart"),
  btnStop: document.getElementById("btnStop"),
  style: document.getElementById("style"),
  height: document.getElementById("height"),
  inseam: document.getElementById("inseam"),
  cardCam: document.getElementById("cardCam"),
  camTitle: document.getElementById("camTitle"),
  rolePill: document.getElementById("rolePill"),
  btnSwitchCam: document.getElementById("btnSwitchCam"),
  v: document.getElementById("v"),
  c: document.getElementById("c"),
  camOut: document.getElementById("camOut"),
  sideCanvas: document.getElementById("sideCanvas"),
  rearCanvas: document.getElementById("rearCanvas"),
  sideOut: document.getElementById("sideOut"),
  rearOut: document.getElementById("rearOut"),
  reco: document.getElementById("reco"),
  kpiKnee: document.getElementById("kpiKnee"),
  kpiElbow: document.getElementById("kpiElbow"),
  kpiRock: document.getElementById("kpiRock"),

  btnNewSession: document.getElementById("btnNewSession"),
  btnSnap: document.getElementById("btnSnap"),
  btnExport: document.getElementById("btnExport"),
  sessionInfo: document.getElementById("sessionInfo"),
  sessionId: document.getElementById("sessionId"),
  sessionList: document.getElementById("sessionList"),

  // demo v2
  demoScenario: document.getElementById("demoScenario"),
  btnDemoLoad: document.getElementById("btnDemoLoad"),
  demoStatePill: document.getElementById("demoStatePill"),
  btnSetBefore: document.getElementById("btnSetBefore"),
  btnSetAfter: document.getElementById("btnSetAfter"),
  btnClearBeforeAfter: document.getElementById("btnClearBeforeAfter"),
  btnAdjSaddleDown: document.getElementById("btnAdjSaddleDown"),
  btnAdjSaddleUp: document.getElementById("btnAdjSaddleUp"),
  btnAdjReachShorter: document.getElementById("btnAdjReachShorter"),
  btnAdjReachLonger: document.getElementById("btnAdjReachLonger"),
  btnAdjReduceRock: document.getElementById("btnAdjReduceRock"),
  demoBeforeOut: document.getElementById("demoBeforeOut"),
  demoAfterOut: document.getElementById("demoAfterOut"),
  demoDeltaOut: document.getElementById("demoDeltaOut"),
  demoJson: document.getElementById("demoJson"),
};

els.wsUrl.value = `ws://${location.hostname || "127.0.0.1"}:8181`;

let ws = null;
let running = false;

let sidePoints = null;
let rearPoints = null;

function setStatus(text, ok){
  els.status.textContent = text;
  els.status.style.borderColor = ok ? "#2a6a3a" : "#6a2a2a";
}
function setCams(online){
  els.cams.textContent = `SIDE: ${online.side ? "ON" : "-"} | REAR: ${online.rear ? "ON" : "-"}`;
}
function profile(){
  return {
    style: els.style.value,
    height_cm: Number(els.height.value||0),
    inseam_cm: Number(els.inseam.value||0)
  };
}

function computeSideMetrics(points){
  const m = { knee: NaN, hip: NaN, elbow: NaN };
  if(points?.hip && points?.knee && points?.ankle) m.knee = angle3(points.hip, points.knee, points.ankle);
  if(points?.shoulder && points?.hip && points?.knee) m.hip = angle3(points.shoulder, points.hip, points.knee);
  if(points?.shoulder && points?.elbow && points?.wrist) m.elbow = angle3(points.shoulder, points.elbow, points.wrist);
  return m;
}

let rearHistory = [];
function computeRearMetrics(points){
  const m = { rocking: NaN, pelvisTilt: NaN, shoulderTilt: NaN };

  if(points?.l_pelvis && points?.r_pelvis){
    m.pelvisTilt = points.l_pelvis.y - points.r_pelvis.y;
  }
  if(points?.l_shoulder && points?.r_shoulder){
    m.shoulderTilt = points.l_shoulder.y - points.r_shoulder.y;
  }

  if(points?.l_pelvis && points?.r_pelvis && points?.l_shoulder && points?.r_shoulder){
    const pelvisMid = { x:(points.l_pelvis.x+points.r_pelvis.x)/2, y:(points.l_pelvis.y+points.r_pelvis.y)/2 };
    const shoulderMid= { x:(points.l_shoulder.x+points.r_shoulder.x)/2, y:(points.l_shoulder.y+points.r_shoulder.y)/2 };
    const torsoH = Math.max(50, Math.abs(pelvisMid.y - shoulderMid.y));
    const tiltNorm = Math.abs(m.pelvisTilt) / torsoH;

    rearHistory.push(tiltNorm);
    if(rearHistory.length>120) rearHistory.shift();

    const max = Math.max(...rearHistory);
    const min = Math.min(...rearHistory);
    m.rocking = (max - min);
  }
  return m;
}

function drawPointsTo(canvas, points, title){
  const ctx = canvas.getContext("2d");
  canvas.width = 640; canvas.height = 360;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth = 2;
  ctx.font = "14px system-ui";
  ctx.strokeStyle = "#fff";
  ctx.fillStyle = "#fff";
  ctx.fillText(title, 10, 20);

  if(!points){
    ctx.fillText("brak punktów", 10, 45);
    return;
  }
  for(const [k,p] of Object.entries(points)){
    if(!p) continue;
    const x = p.x * 0.5;
    const y = p.y * 0.5;
    ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.stroke();
    ctx.fillText(k, x+8, y);
  }
}
function setKpi(sideM, rearM){
  els.kpiKnee.textContent = `Kolano: ${Number.isFinite(sideM.knee) ? sideM.knee.toFixed(1)+"°" : "-"}`;
  els.kpiElbow.textContent = `Łokieć: ${Number.isFinite(sideM.elbow) ? sideM.elbow.toFixed(1)+"°" : "-"}`;
  els.kpiRock.textContent = `Rocking: ${Number.isFinite(rearM.rocking) ? rearM.rocking.toFixed(3) : "-"}`;
}
function renderReco(sideMetrics, rearMetrics){
  const items = recommendations(profile(), sideMetrics, rearMetrics);
  els.reco.innerHTML = items.map(it => `
    <div class="item ${it.lvl}">
      <div><b>${it.title}</b></div>
      <div><small>${it.why}</small></div>
      <div>${it.do}</div>
    </div>
  `).join("");
  return items;
}

function updateHubUI(){
  const sideM = computeSideMetrics(sidePoints);
  const rearM = computeRearMetrics(rearPoints);

  drawPointsTo(els.sideCanvas, sidePoints, "BOK (punkty)");
  drawPointsTo(els.rearCanvas, rearPoints, "TYŁ (punkty)");

  els.sideOut.textContent = JSON.stringify({points: sidePoints, metrics: sideM}, null, 2);
  els.rearOut.textContent = JSON.stringify({points: rearPoints, metrics: rearM}, null, 2);

  setKpi(sideM, rearM);
  renderReco(sideM, rearM);

  // DEMO v2 podgląd live
  els.demoJson.textContent = JSON.stringify({side: sidePoints, rear: rearPoints}, null, 2);
  demoRenderCompare();
}

/** =========================
 *  WebSocket
 *  ========================= */
function connectWS(){
  const url = els.wsUrl.value.trim();
  if(!url) return alert("Podaj WS URL (np. ws://IP:8181)");
  ws = new WebSocket(url);

  ws.onopen = () => {
    setStatus("ONLINE", true);
    ws.send(JSON.stringify({type:"join", room: els.room.value.trim()||"default", role: currentRole()}));
  };
  ws.onclose = () => setStatus("OFFLINE", false);
  ws.onerror = () => setStatus("ERROR", false);

  ws.onmessage = (ev) => {
    let msg; try{ msg = JSON.parse(ev.data);}catch{ return; }
    if(msg.type==="status"){ setCams(msg.online||{side:false,rear:false}); }
    if(msg.type==="points"){
      if(msg.role==="side") sidePoints = msg.points;
      if(msg.role==="rear") rearPoints = msg.points;
      if(els.mode.value==="hub") updateHubUI();
    }
    if(msg.type==="cmd"){
      if(msg.cmd==="start"){ running = true; camLoop(); }
      if(msg.cmd==="stop"){ running = false; }
    }
  };
}
function sendCmd(cmd){
  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({type:"cmd", room: els.room.value.trim()||"default", cmd}));
  }
}

/** =========================
 *  Kamera (telefony) – bez zmian logicznych
 *  ========================= */
let stream = null;
let facing = "environment";
const ctx = els.c.getContext("2d", { willReadFrequently: true });

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: facing, width:{ideal:1280}, height:{ideal:720} },
    audio: false
  });
  els.v.srcObject = stream;
}
function currentRole(){
  if(els.mode.value==="hub") return "hub";
  if(els.mode.value==="cam_side") return "side";
  if(els.mode.value==="cam_rear") return "rear";
  return "hub";
}
function detectPoints(role, img, w, h){
  if(role==="side"){
    return {
      hip:   findCentroid(img,w,h,HSV.neonGreen),
      knee:  findCentroid(img,w,h,HSV.pinkWrap),
      ankle: findCentroid(img,w,h,HSV.cyan),
      shoulder: findCentroid(img,w,h,HSV.orange),
      elbow:    findCentroid(img,w,h,HSV.yellow),
      wrist:    findCentroid(img,w,h,HSV.purple),
    };
  }
  return {
    l_shoulder: findCentroid(img,w,h,HSV.orange),
    r_shoulder: findCentroid(img,w,h,HSV.yellow),
    l_pelvis:   findCentroid(img,w,h,HSV.neonGreen),
    r_pelvis:   findCentroid(img,w,h,HSV.pinkWrap),
  };
}
function camLoop(){
  const role = currentRole();
  if(!(role==="side"||role==="rear")) return;
  if(!running) return;

  if(!els.v.videoWidth){ requestAnimationFrame(camLoop); return; }

  const w = els.v.videoWidth, h = els.v.videoHeight;
  els.c.width = w; els.c.height = h;
  ctx.drawImage(els.v,0,0,w,h);
  const img = ctx.getImageData(0,0,w,h);
  const pts = detectPoints(role, img, w, h);

  ctx.lineWidth = 3; ctx.font = "16px system-ui";
  for(const [k,p] of Object.entries(pts)){
    if(!p) continue;
    drawDot(ctx, p, k);
  }

  const payload = {};
  for(const [k,p] of Object.entries(pts)){
    payload[k] = p ? {x:p.x, y:p.y} : null;
  }
  els.camOut.textContent = JSON.stringify(payload, null, 2);

  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({type:"points", t: performance.now(), role, points: payload}));
  }
  requestAnimationFrame(camLoop);
}

/** =========================
 *  Sesja
 *  ========================= */
let session = { id:null, createdAt:null, snaps:[] };
function newSession(){
  session = {
    id: `S-${Math.random().toString(16).slice(2,8)}-${Date.now().toString(16).slice(-6)}`.toUpperCase(),
    createdAt: new Date().toISOString(),
    snaps: []
  };
  renderSession();
}
function renderSession(){
  els.sessionInfo.textContent = `SNAP: ${session.snaps.length}`;
  els.sessionId.textContent = `ID: ${session.id || "-"}`;
  els.sessionList.innerHTML = session.snaps.map((s,idx)=>`
    <div class="snap">
      <div class="snapHeader">
        <div><b>SNAP #${idx+1}</b> <span class="tag">${new Date(s.t).toLocaleString()}</span></div>
        <div class="tag">${s.profile.style.toUpperCase()}</div>
      </div>
      <div class="muted">Kolano: ${Number.isFinite(s.side.knee)?s.side.knee.toFixed(1)+"°":"-"} |
        Łokieć: ${Number.isFinite(s.side.elbow)?s.side.elbow.toFixed(1)+"°":"-"} |
        Rocking: ${Number.isFinite(s.rear.rocking)?s.rear.rocking.toFixed(3):"-"}</div>
      <details>
        <summary>Rekomendacje (${s.reco.length})</summary>
        <div style="margin-top:8px">${s.reco.map(r=>`<div class="item ${r.lvl}"><b>${r.title}</b><div class="muted">${r.why}</div><div>${r.do}</div></div>`).join("")}</div>
      </details>
    </div>
  `).join("");
}
function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
els.btnNewSession.onclick = () => newSession();
els.btnSnap.onclick = () => {
  const sideM = computeSideMetrics(sidePoints);
  const rearM = computeRearMetrics(rearPoints);
  const recoItems = recommendations(profile(), sideM, rearM);

  session.snaps.push({
    t: new Date().toISOString(),
    profile: profile(),
    side: sideM,
    rear: rearM,
    points: { side: sidePoints, rear: rearPoints },
    reco: recoItems
  });
  renderSession();
};
els.btnExport.onclick = () => {
  if(!session.id) newSession();
  downloadJson(`${session.id}.json`, session);
};

/** =========================
 *  DEMO v2
 *  ========================= */
const DEMO_PRESETS = {
  ok: {
    side: { hip:{x:400,y:300}, knee:{x:520,y:420}, ankle:{x:560,y:560}, shoulder:{x:320,y:180}, elbow:{x:260,y:240}, wrist:{x:220,y:280} },
    rear: { l_shoulder:{x:420,y:200}, r_shoulder:{x:520,y:200}, l_pelvis:{x:440,y:360}, r_pelvis:{x:500,y:362} }
  },
  saddle_high: {
    side: { hip:{x:400,y:300}, knee:{x:520,y:420}, ankle:{x:610,y:520}, shoulder:{x:320,y:180}, elbow:{x:260,y:240}, wrist:{x:220,y:280} },
    rear: { l_shoulder:{x:420,y:200}, r_shoulder:{x:520,y:200}, l_pelvis:{x:440,y:345}, r_pelvis:{x:500,y:390} }
  },
  saddle_low: {
    side: { hip:{x:400,y:300}, knee:{x:520,y:430}, ankle:{x:550,y:590}, shoulder:{x:320,y:180}, elbow:{x:260,y:240}, wrist:{x:220,y:280} },
    rear: { l_shoulder:{x:420,y:200}, r_shoulder:{x:520,y:200}, l_pelvis:{x:450,y:370}, r_pelvis:{x:490,y:372} }
  },
  reach_long: {
    side: { hip:{x:400,y:300}, knee:{x:520,y:420}, ankle:{x:560,y:560}, shoulder:{x:320,y:180}, elbow:{x:235,y:215}, wrist:{x:145,y:215} },
    rear: { l_shoulder:{x:420,y:200}, r_shoulder:{x:520,y:200}, l_pelvis:{x:440,y:360}, r_pelvis:{x:500,y:362} }
  },
  pelvis_asym: {
    side: { hip:{x:400,y:300}, knee:{x:520,y:420}, ankle:{x:560,y:560}, shoulder:{x:320,y:180}, elbow:{x:260,y:240}, wrist:{x:220,y:280} },
    rear: { l_shoulder:{x:420,y:200}, r_shoulder:{x:520,y:200}, l_pelvis:{x:440,y:340}, r_pelvis:{x:500,y:395} }
  },
  shoulder_asym: {
    side: { hip:{x:400,y:300}, knee:{x:520,y:420}, ankle:{x:560,y:560}, shoulder:{x:320,y:180}, elbow:{x:260,y:240}, wrist:{x:220,y:280} },
    rear: { l_shoulder:{x:420,y:185}, r_shoulder:{x:520,y:220}, l_pelvis:{x:440,y:360}, r_pelvis:{x:500,y:362} }
  },
  rocking_high: {
    side: { hip:{x:400,y:300}, knee:{x:520,y:420}, ankle:{x:600,y:520}, shoulder:{x:320,y:180}, elbow:{x:260,y:240}, wrist:{x:220,y:280} },
    rear: { l_shoulder:{x:420,y:200}, r_shoulder:{x:520,y:200}, l_pelvis:{x:440,y:330}, r_pelvis:{x:500,y:410} }
  }
};

let demoBefore = null; // {side,rear}
let demoAfter  = null; // {side,rear}

function demoLoadScenario(key){
  const preset = DEMO_PRESETS[key] || DEMO_PRESETS.ok;
  sidePoints = deepClone(preset.side);
  rearPoints = deepClone(preset.rear);
  rearHistory = []; // reset historii rocking
  els.demoStatePill.textContent = `TRYB: LIVE (${key})`;
  updateHubUI();
}
function demoSetBefore(){
  demoBefore = { side: deepClone(sidePoints), rear: deepClone(rearPoints) };
  els.demoStatePill.textContent = `TRYB: LIVE (PRZED ustawione)`;
  demoRenderCompare();
}
function demoSetAfter(){
  demoAfter = { side: deepClone(sidePoints), rear: deepClone(rearPoints) };
  els.demoStatePill.textContent = `TRYB: LIVE (PO ustawione)`;
  demoRenderCompare();
}
function demoClearBeforeAfter(){
  demoBefore = null;
  demoAfter = null;
  els.demoBeforeOut.textContent = "brak";
  els.demoAfterOut.textContent = "brak";
  els.demoDeltaOut.textContent = "brak";
  els.demoStatePill.textContent = "TRYB: LIVE";
}
function fmtM(m){
  return {
    knee: Number.isFinite(m.knee) ? Number(m.knee.toFixed(2)) : null,
    elbow: Number.isFinite(m.elbow) ? Number(m.elbow.toFixed(2)) : null,
    rocking: Number.isFinite(m.rocking) ? Number(m.rocking.toFixed(4)) : null,
  };
}
function demoComputeMetrics(state){
  const sideM = computeSideMetrics(state?.side);
  const rearM = computeRearMetrics(state?.rear);
  return { side: sideM, rear: rearM };
}
function demoRenderCompare(){
  if(demoBefore){
    const mb = demoComputeMetrics(demoBefore);
    els.demoBeforeOut.textContent = JSON.stringify({ side: fmtM(mb.side), rear: fmtM(mb.rear) }, null, 2);
  } else {
    els.demoBeforeOut.textContent = "brak";
  }
  if(demoAfter){
    // UWAGA: computeRearMetrics używa historii, więc do porównania liczymy "statycznie":
    // zrobimy uproszczenie: rocking wyliczamy jako abs(tilt)/torsoH * 0.06 (symulacja)
    const sideM = computeSideMetrics(demoAfter.side);
    const rearM = computeRearMetrics(demoAfter.rear);
    els.demoAfterOut.textContent = JSON.stringify({ side: fmtM(sideM), rear: fmtM(rearM) }, null, 2);
  } else {
    els.demoAfterOut.textContent = "brak";
  }

  if(demoBefore && demoAfter){
    // delta (po - przed)
    const mb = demoComputeMetrics(demoBefore);
    const ma = demoComputeMetrics(demoAfter);
    const d = {
      knee: (Number.isFinite(ma.side.knee) && Number.isFinite(mb.side.knee)) ? Number((ma.side.knee - mb.side.knee).toFixed(2)) : null,
      elbow:(Number.isFinite(ma.side.elbow)&& Number.isFinite(mb.side.elbow))? Number((ma.side.elbow - mb.side.elbow).toFixed(2)) : null,
      rocking:(Number.isFinite(ma.rear.rocking) && Number.isFinite(mb.rear.rocking)) ? Number((ma.rear.rocking - mb.rear.rocking).toFixed(4)) : null
    };
    els.demoDeltaOut.textContent = JSON.stringify(d, null, 2);
  } else {
    els.demoDeltaOut.textContent = "brak";
  }
}

// Korekty DEMO – proste przekształcenia punktów (symulacje)
function adjSaddle(mm){
  // mm -> px w DEMO (umownie)
  const px = mm * 1.2;
  // "siodło niżej" zwykle zwiększa ugięcie kolana -> w DEMO przesuwamy ankle w dół i minimalnie knee
  if(sidePoints?.ankle) sidePoints.ankle.y += px;
  if(sidePoints?.knee)  sidePoints.knee.y  += px*0.4;
  // rocking często maleje przy poprawie -> trochę wyrównujemy miednicę
  if(rearPoints?.l_pelvis && rearPoints?.r_pelvis){
    rearPoints.l_pelvis.y += px*0.2;
    rearPoints.r_pelvis.y += px*0.2;
  }
  updateHubUI();
}
function adjReach(mm){
  const px = mm * 1.0; // 10mm -> 10px
  // reach krótszy: nadgarstek i łokieć bliżej barku (x w prawo w naszym DEMO? u nas "dłoń" jest bardziej w lewo)
  if(sidePoints?.wrist) sidePoints.wrist.x += px;
  if(sidePoints?.elbow) sidePoints.elbow.x += px*0.6;
  updateHubUI();
}
function reduceRocking(){
  if(rearPoints?.l_pelvis && rearPoints?.r_pelvis){
    const mid = (rearPoints.l_pelvis.y + rearPoints.r_pelvis.y) / 2;
    rearPoints.l_pelvis.y = mid - 2;
    rearPoints.r_pelvis.y = mid + 2;
  }
  updateHubUI();
}

els.btnDemoLoad.onclick = () => demoLoadScenario(els.demoScenario.value);
els.btnSetBefore.onclick = () => demoSetBefore();
els.btnSetAfter.onclick = () => demoSetAfter();
els.btnClearBeforeAfter.onclick = () => demoClearBeforeAfter();

els.btnAdjSaddleDown.onclick = () => adjSaddle(+5);   // "siodło -5mm" => w DEMO przesuwamy dół segmentu nogi tak, by kolano się zgięło
els.btnAdjSaddleUp.onclick   = () => adjSaddle(-5);   // "siodło +5mm"
els.btnAdjReachShorter.onclick = () => adjReach(+10); // reach -10mm => w DEMO ręka "wraca" (x rośnie)
els.btnAdjReachLonger.onclick  = () => adjReach(-10); // reach +10mm
els.btnAdjReduceRock.onclick   = () => reduceRocking();

/** =========================
 *  UI zachowanie
 *  ========================= */
function applyMode(){
  const m = els.mode.value;
  const isCam = (m==="cam_side" || m==="cam_rear");
  const isHub = (m==="hub");
  const isDemo= (m==="demo");

  els.cardCam.style.display = isCam ? "" : "none";
  document.getElementById("cardSide").style.display = (isHub || isDemo) ? "" : "none";
  document.getElementById("cardRear").style.display = (isHub || isDemo) ? "" : "none";
  document.getElementById("cardDemo").style.display = isDemo ? "" : "none";

  if(isCam){
    els.rolePill.textContent = `ROLE: ${m==="cam_side" ? "SIDE" : "REAR"}`;
    els.camTitle.textContent = `Kamera ${m==="cam_side" ? "BOK" : "TYŁ"}`;
  }
  if(isDemo){
    // w demo od razu render
    updateHubUI();
  }
}
els.mode.onchange = applyMode;

els.btnConnect.onclick = () => connectWS();
els.btnStart.onclick = () => { running = true; sendCmd("start"); camLoop(); };
els.btnStop.onclick = () => { running = false; sendCmd("stop"); };

els.btnSwitchCam.onclick = async () => {
  facing = (facing==="environment") ? "user" : "environment";
  try{ await startCamera(); }catch(e){ alert("Nie mogę uruchomić kamery: " + e.message); }
};

// init
(async () => {
  if(!session.id) newSession();
  applyMode();

  // start demo by default
  demoLoadScenario("ok");
  demoClearBeforeAfter();
})();
</script>
</body>
</html>
