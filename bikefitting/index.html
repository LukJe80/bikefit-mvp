<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bikefit LIVE – Instruktor (PWA)</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0c"/>

  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#141416;
      --border:#26262a;
      --muted:#9aa0a6;
      --ok:#2a6a3a;
      --warn:#6a5a2a;
      --bad:#6a2a2a;
      --text:#fff;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{padding:12px 14px;background:var(--panel);border-bottom:1px solid var(--border)}
    h1{margin:0 0 8px 0;font-size:16px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    select,input,button{
      padding:8px 10px;border-radius:10px;border:1px solid #333;background:#0f0f11;color:#fff
    }
    button{cursor:pointer}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #333;background:#0f0f11;font-size:12px}
    .pill b{font-weight:700}
    .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;padding:12px}
    @media (max-width: 1100px){ .layout{grid-template-columns:1fr} }

    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .card h2{margin:0 0 8px 0;font-size:14px}
    .videoWrap{position:relative;border-radius:14px;overflow:hidden;background:#000;border:1px solid var(--border)}
    video,canvas{display:block;width:100%;height:auto}
    canvas{position:absolute;left:0;top:0}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .big{
      font-size:18px;font-weight:800;margin:6px 0 8px 0
    }
    .coachBox{
      border:1px solid #2a2a2f;border-radius:14px;padding:12px;background:#101014
    }
    .coachBox.ok{border-color:var(--ok)}
    .coachBox.warn{border-color:var(--warn)}
    .coachBox.bad{border-color:var(--bad)}
    .metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width: 700px){ .metrics{grid-template-columns:1fr} }
    .m{border:1px solid #2a2a2f;border-radius:12px;padding:10px;background:#0f0f11}
    .m .k{color:var(--muted);font-size:12px}
    .m .v{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:16px;margin-top:4px}
    .mini{font-size:12px;color:var(--muted)}
    .line{height:1px;background:#26262a;margin:10px 0}
  </style>
</head>
<body>
<header>
  <h1>Bikefit LIVE – Instruktor (PWA) • 1 kamera (bok)</h1>
  <div class="row">
    <button id="btnStart">Start kamery</button>
    <button id="btnStop">Stop</button>

    <span class="pill">Status: <b id="status">OFF</b></span>

    <label class="pill">Cel:
      <select id="goal">
        <option value="comfort">Komfort</option>
        <option value="neutral" selected>Neutral</option>
        <option value="aero">Aero</option>
      </select>
    </label>

    <label class="pill">Dyscyplina:
      <select id="style">
        <option value="road" selected>Szosa</option>
        <option value="gravel">Gravel</option>
        <option value="mtb">MTB</option>
      </select>
    </label>

    <label class="pill">Wzrost (cm):
      <input id="height" type="number" value="175" style="width:84px"/>
    </label>

    <label class="pill">Przekrok (cm):
      <input id="inseam" type="number" value="82" style="width:84px"/>
    </label>

    <label class="pill">Tryb:
      <select id="stepMode">
        <option value="live" selected>LIVE (bez nagrywania)</option>
        <option value="guided">Instruktor krok po kroku</option>
      </select>
    </label>
  </div>
  <div class="hint" style="margin-top:8px">
    Tip: kamera działa najlepiej na <b>HTTPS</b> (Vercel) albo <b>http://localhost</b>. Ustaw laptop bokiem do roweru: widoczne biodro–kolano–kostka.
  </div>
</header>

<main class="layout">
  <section class="card">
    <h2>Podgląd + punkty</h2>
    <div class="videoWrap">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="mini" style="margin-top:8px">
      Jeśli obraz jest czarny: sprawdź uprawnienia kamery w przeglądarce / systemie.
    </div>
  </section>

  <section class="card">
    <h2>Instruktor</h2>

    <div id="coach" class="coachBox warn">
      <div class="mini">Wskazówka</div>
      <div class="big" id="coachTitle">Uruchom kamerę</div>
      <div id="coachText" class="hint">Kliknij “Start kamery”.</div>
    </div>

    <div class="line"></div>

    <div class="metrics">
      <div class="m">
        <div class="k">Kąt kolana (DMP / dolny zakres)</div>
        <div class="v" id="kneeOut">—</div>
        <div class="mini">Najważniejsze do wysokości siodła.</div>
      </div>
      <div class="m">
        <div class="k">Kąt łokcia (przybliżony)</div>
        <div class="v" id="elbowOut">—</div>
        <div class="mini">Pomaga ocenić reach / mostek.</div>
      </div>
      <div class="m">
        <div class="k">Kąt tułowia (przybliżony)</div>
        <div class="v" id="torsoOut">—</div>
        <div class="mini">Pomaga ocenić drop / wysokość kokpitu.</div>
      </div>
      <div class="m">
        <div class="k">Stabilność (szac.)</div>
        <div class="v" id="stabOut">—</div>
        <div class="mini">Wykrywa “szarpanie” / brak pewności punktów.</div>
      </div>
    </div>

    <div class="line"></div>
    <div class="hint">
      <b>Instruktor krok po kroku</b> (tryb Guided) działa tak:
      wybiera 1 temat → daje zmianę (np. 3–5 mm) → czeka aż ustabilizujesz jazdę → ocenia czy jest lepiej.
    </div>
  </section>
</main>

<!-- MediaPipe Pose (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

<script>
(() => {
  // ---------- UI ----------
  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const ctx = overlay.getContext("2d");

  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const statusEl = document.getElementById("status");

  const goalEl = document.getElementById("goal");
  const styleEl = document.getElementById("style");
  const stepModeEl = document.getElementById("stepMode");

  const kneeOut = document.getElementById("kneeOut");
  const elbowOut = document.getElementById("elbowOut");
  const torsoOut = document.getElementById("torsoOut");
  const stabOut = document.getElementById("stabOut");

  const coachBox = document.getElementById("coach");
  const coachTitle = document.getElementById("coachTitle");
  const coachText = document.getElementById("coachText");

  function setStatus(txt){ statusEl.textContent = txt; }

  // ---------- Math helpers ----------
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function angleABC(a,b,c){
    // angle at b from points a-b-c (in degrees)
    if(!a||!b||!c) return NaN;
    const ab = {x:a.x-b.x, y:a.y-b.y};
    const cb = {x:c.x-b.x, y:c.y-b.y};
    const dot = ab.x*cb.x + ab.y*cb.y;
    const nab = Math.hypot(ab.x, ab.y);
    const ncb = Math.hypot(cb.x, cb.y);
    const cos = dot / (nab*ncb + 1e-9);
    const v = clamp(cos, -1, 1);
    return Math.acos(v) * 180 / Math.PI;
  }

  // ---------- Rolling windows (stabilność + uśrednianie) ----------
  function rolling(n){
    const arr = [];
    return {
      push(v){ arr.push(v); if(arr.length>n) arr.shift(); },
      mean(){
        const ok = arr.filter(x => Number.isFinite(x));
        if(!ok.length) return NaN;
        return ok.reduce((a,b)=>a+b,0)/ok.length;
      },
      std(){
        const m = this.mean();
        if(!Number.isFinite(m)) return NaN;
        const ok = arr.filter(x => Number.isFinite(x));
        const v = ok.reduce((a,b)=>a+(b-m)*(b-m),0)/ok.length;
        return Math.sqrt(v);
      },
      last(){ return arr.length?arr[arr.length-1]:NaN; },
      size(){ return arr.length; }
    };
  }

  const kneeWin = rolling(45);   // ok. ~1.5s przy 30fps
  const elbowWin = rolling(45);
  const torsoWin = rolling(45);
  const confWin = rolling(45);

  // ---------- Coach targets (proste, stabilne na MVP) ----------
  function targets(){
    const style = styleEl.value;
    const goal = goalEl.value;

    // Zakresy są celowo "bezpieczne" (nie ekstremalne).
    // To MVP – dopracujemy po testach.
    let knee = [140, 155]; // (większy = bardziej wyprostowane)
    let elbow = [145, 170];
    let torso = [35, 55];  // im mniejszy, tym bardziej aero (przybliżenie)

    if(style === "mtb"){
      knee = [138, 153];
      elbow = [150, 175];
      torso = [40, 65];
    } else if(style === "gravel"){
      knee = [139, 154];
      elbow = [148, 173];
      torso = [38, 60];
    }

    if(goal === "comfort"){
      elbow = [150, 175];
      torso = [45, 70];
    } else if(goal === "aero"){
      elbow = [140, 165];
      torso = [30, 50];
    }

    return { knee, elbow, torso };
  }

  // ---------- Guided step state ----------
  const guided = {
    step: 0, // 0=setup, 1=siodlo, 2=reach, 3=drop
    lockUntilStable: false,
    lastAdviceAt: 0
  };

  function setCoach(level, title, text){
    coachBox.classList.remove("ok","warn","bad");
    coachBox.classList.add(level);
    coachTitle.textContent = title;
    coachText.textContent = text;
  }

  function mmStepText(){
    // małe kroki (bezpieczne)
    return "Zmieniaj małymi krokami: 3–5 mm i ponownie oceń po ~10–20 obrotach.";
  }

  function liveCoach(knee, elbow, torso, stability){
    const t = targets();

    // jeśli niski confidence / niestabilnie:
    if(stability < 0.55){
      setCoach("warn","Ustaw kadr i światło",
        "Nie łapię stabilnie punktów. Ustaw kamerę bokiem, doświetl, pokaż biodro–kolano–kostkę. Potem wróć do pedałowania.");
      return;
    }

    // priorytet: siodło (kolano)
    if(Number.isFinite(knee)){
      if(knee > t.knee[1]){
        setCoach("bad","Kolano zbyt wyprostowane",
          `Kąt kolana ~ ${knee.toFixed(1)}° (za dużo). Najczęściej siodło jest za wysoko → obniż o 3–5 mm. ${mmStepText()}`);
        return;
      }
      if(knee < t.knee[0]){
        setCoach("bad","Kolano zbyt ugięte",
          `Kąt kolana ~ ${knee.toFixed(1)}° (za mało). Najczęściej siodło jest za nisko → podnieś o 3–5 mm. ${mmStepText()}`);
        return;
      }
    }

    // reach (łokieć)
    if(Number.isFinite(elbow)){
      if(elbow > t.elbow[1]){
        setCoach("warn","Możliwie za duży reach",
          `Łokieć ~ ${elbow.toFixed(1)}° (prawie prosta ręka). Test: krótszy mostek o 10 mm lub 5–10 mm wyżej kokpit.`);
        return;
      }
      if(elbow < t.elbow[0]){
        setCoach("warn","Możliwie za krótki reach / zbyt “ciasno”",
          `Łokieć ~ ${elbow.toFixed(1)}° (mocno ugięty). Jeśli nie celujesz w aero: test dłuższy mostek +10 mm lub trochę niżej/ dalej chwyt.`);
        return;
      }
    }

    // drop / tułów
    if(Number.isFinite(torso)){
      if(torso > t.torso[1]){
        setCoach("warn","Tułów zbyt pionowo",
          `Tułów ~ ${torso.toFixed(1)}° (wysoko). Jeśli chcesz bardziej aero: niżej kokpit (5 mm) lub dłuższy mostek (10 mm) – jedna zmiana naraz.`);
        return;
      }
      if(torso < t.torso[0]){
        setCoach("warn","Tułów bardzo nisko",
          `Tułów ~ ${torso.toFixed(1)}° (nisko). Jeśli czujesz napięcia: podnieś kokpit 5–10 mm (podkładka / mostek).`);
        return;
      }
    }

    setCoach("ok","Wygląda dobrze (LIVE)",
      "Kąty są w bezpiecznym zakresie. Jeśli chcesz, przełącz tryb na „Instruktor krok po kroku”, a poprowadzę zmiany 1 po 1.");
  }

  function guidedCoach(knee, elbow, torso, stability){
    const t = targets();

    if(stability < 0.55){
      setCoach("warn","Krok 0: ustaw kadr",
        "Ustaw kamerę bokiem: biodro–kolano–kostka w kadrze. Doświetl. Wróć do pedałowania.");
      guided.step = 0;
      return;
    }

    // uśrednione wartości
    const km = knee;
    const em = elbow;
    const tm = torso;

    if(guided.step === 0){
      setCoach("warn","Krok 1: siodło (wysokość)",
        "Jedź stabilnie 10–15 s. Potem pokażę, czy podnieść/obniżyć siodło.");
      guided.step = 1;
      return;
    }

    if(guided.step === 1){
      if(!Number.isFinite(km)){
        setCoach("warn","Krok 1: brak kąta kolana",
          "Nie widzę punktów nogi. Pokaż biodro–kolano–kostkę.");
        return;
      }
      if(km > t.knee[1]){
        setCoach("bad","Krok 1: obniż siodło",
          `Kąt kolana ~ ${km.toFixed(1)}° (za duży). Obniż siodło o 3–5 mm i jedź 10–20 obrotów, aż wartości się ustabilizują.`);
        return;
      }
      if(km < t.knee[0]){
        setCoach("bad","Krok 1: podnieś siodło",
          `Kąt kolana ~ ${km.toFixed(1)}° (za mały). Podnieś siodło o 3–5 mm i jedź 10–20 obrotów.`);
        return;
      }
      setCoach("ok","Krok 1: siodło OK",
        `Kolano ~ ${km.toFixed(1)}° w zakresie. Przechodzimy do reach (mostek).`);
      guided.step = 2;
      return;
    }

    if(guided.step === 2){
      if(!Number.isFinite(em)){
        setCoach("warn","Krok 2: brak kąta łokcia",
          "Nie widzę dobrze ręki. Spróbuj tak, by bark–łokieć–nadgarstek były w kadrze.");
        return;
      }
      if(em > t.elbow[1]){
        setCoach("warn","Krok 2: skróć reach",
          `Łokieć ~ ${em.toFixed(1)}° (za prosto). Test: mostek -10 mm albo 5–10 mm wyżej kokpit (jedno naraz).`);
        return;
      }
      if(em < t.elbow[0]){
        setCoach("warn","Krok 2: wydłuż reach",
          `Łokieć ~ ${em.toFixed(1)}° (za ugięty). Test: mostek +10 mm lub bardziej „do przodu” chwyt.`);
        return;
      }
      setCoach("ok","Krok 2: reach OK",
        `Łokieć ~ ${em.toFixed(1)}° w zakresie. Przechodzimy do tułowia (drop).`);
      guided.step = 3;
      return;
    }

    if(guided.step === 3){
      if(!Number.isFinite(tm)){
        setCoach("warn","Krok 3: brak kąta tułowia",
          "Nie widzę stabilnie barku i biodra. Popraw kadr.");
        return;
      }
      if(tm > t.torso[1]){
        setCoach("warn","Krok 3: tułów zbyt wysoko",
          `Tułów ~ ${tm.toFixed(1)}°. Jeśli chcesz bardziej aero: obniż kokpit o 5 mm i ponownie oceń.`);
        return;
      }
      if(tm < t.torso[0]){
        setCoach("warn","Krok 3: tułów bardzo nisko",
          `Tułów ~ ${tm.toFixed(1)}°. Jeśli czujesz napięcie: podnieś kokpit 5–10 mm.`);
        return;
      }
      setCoach("ok","Krok 3: drop OK",
        "Podstawy ustawione. Jeśli chcesz, dodamy tryb TYŁ (druga kamera) w kolejnym etapie.");
      return;
    }
  }

  // ---------- MediaPipe Pose ----------
  let camera = null;
  let pose = null;
  let running = false;

  function resizeOverlay(){
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;
    overlay.width = w;
    overlay.height = h;
  }

  function lm(landmarks, idx){
    const p = landmarks[idx];
    if(!p) return null;
    return { x: p.x*overlay.width, y: p.y*overlay.height, v: p.visibility ?? 0 };
  }

  function stabilityScore(landmarks){
    // średnia widoczność kluczowych punktów z boku
    const need = [11,12,23,24,25,26,27,28,13,14,15,16]; // shoulders/hips/knees/ankles/elbows/wrists
    let sum=0, n=0;
    for(const i of need){
      const v = landmarks[i]?.visibility;
      if(typeof v === "number"){ sum += v; n++; }
    }
    const s = n ? (sum/n) : 0;
    return s; // 0..1
  }

  function pickSideLandmarks(landmarks){
    // wybierz lepszą stronę (większa widoczność: hip/knee/ankle)
    const left = (landmarks[23]?.visibility||0) + (landmarks[25]?.visibility||0) + (landmarks[27]?.visibility||0);
    const right= (landmarks[24]?.visibility||0) + (landmarks[26]?.visibility||0) + (landmarks[28]?.visibility||0);
    return (right > left) ? "right" : "left";
  }

  function computeAngles(landmarks){
    const side = pickSideLandmarks(landmarks);

    // indices:
    // left: shoulder11 elbow13 wrist15 hip23 knee25 ankle27
    // right: shoulder12 elbow14 wrist16 hip24 knee26 ankle28
    const idx = (side==="right")
      ? {sh:12, el:14, wr:16, hip:24, knee:26, an:28}
      : {sh:11, el:13, wr:15, hip:23, knee:25, an:27};

    const hip = lm(landmarks, idx.hip);
    const knee = lm(landmarks, idx.knee);
    const an  = lm(landmarks, idx.an);

    const sh  = lm(landmarks, idx.sh);
    const el  = lm(landmarks, idx.el);
    const wr  = lm(landmarks, idx.wr);

    // knee angle
    const kneeAng = angleABC(hip, knee, an);

    // elbow: shoulder-elbow-wrist
    const elbowAng = angleABC(sh, el, wr);

    // torso angle approx: angle between (shoulder->hip) vector and horizontal
    let torsoAng = NaN;
    if(sh && hip){
      const vx = hip.x - sh.x;
      const vy = hip.y - sh.y;
      // angle to horizontal axis
      torsoAng = Math.abs(Math.atan2(vy, vx) * 180/Math.PI);
      // normalize to 0..90-ish
      if(torsoAng > 90) torsoAng = 180 - torsoAng;
    }

    return { side, knee:kneeAng, elbow:elbowAng, torso:torsoAng };
  }

  function draw(landmarks){
    ctx.clearRect(0,0,overlay.width, overlay.height);

    // draw video frame is handled by camera/video element itself; overlay only draws points/lines
    // draw connectors for clarity
    const conns = [
      [11,13],[13,15],
      [12,14],[14,16],
      [11,23],[12,24],
      [23,25],[25,27],
      [24,26],[26,28],
      [23,24],[11,12]
    ];

    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(255,255,255,.7)";
    ctx.fillStyle = "rgba(255,255,255,.8)";
    ctx.font = "18px system-ui";

    // connectors
    for(const [a,b] of conns){
      const pa = lm(landmarks, a);
      const pb = lm(landmarks, b);
      if(!pa || !pb) continue;
      ctx.beginPath();
      ctx.moveTo(pa.x, pa.y);
      ctx.lineTo(pb.x, pb.y);
      ctx.stroke();
    }

    // points
    for(let i=0;i<landmarks.length;i++){
      const p = lm(landmarks, i);
      if(!p) continue;
      if((landmarks[i].visibility ?? 0) < 0.2) continue;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function fmt(v){
    return Number.isFinite(v) ? `${v.toFixed(1)}°` : "—";
  }

  pose = new Pose.Pose({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
  });

  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    smoothSegmentation: false,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults((res) => {
    if(!running) return;
    if(!res.poseLandmarks){
      setCoach("warn","Brak sylwetki w kadrze","Ustaw kamerę tak, aby widać było całego rowerzystę.");
      setStatus("NO POSE");
      return;
    }

    resizeOverlay();
    draw(res.poseLandmarks);

    const stab = stabilityScore(res.poseLandmarks);
    confWin.push(stab);

    const a = computeAngles(res.poseLandmarks);
    kneeWin.push(a.knee);
    elbowWin.push(a.elbow);
    torsoWin.push(a.torso);

    const knee = kneeWin.mean();
    const elbow = elbowWin.mean();
    const torso = torsoWin.mean();
    const stability = confWin.mean();

    kneeOut.textContent = fmt(knee);
    elbowOut.textContent = fmt(elbow);
    torsoOut.textContent = fmt(torso);
    stabOut.textContent = Number.isFinite(stability) ? stability.toFixed(2) : "—";

    setStatus("LIVE");

    if(stepModeEl.value === "guided"){
      guidedCoach(knee, elbow, torso, stability);
    } else {
      liveCoach(knee, elbow, torso, stability);
    }
  });

  async function start(){
    if(running) return;
    try{
      setCoach("warn","Uruchamiam kamerę…","Zezwól na dostęp do kamery, jeśli przeglądarka zapyta.");
      setStatus("STARTING");
      running = true;

      camera = new CameraUtils.Camera(video, {
        onFrame: async () => {
          if(!running) return;
          await pose.send({image: video});
        },
        width: 1280,
        height: 720
      });

      await camera.start();
      setStatus("LIVE");
      setCoach("warn","LIVE – zbieram stabilne wartości","Jedź stabilnie 10–15 sekund, potem podam wskazówki.");
    }catch(e){
      running = false;
      setStatus("ERROR");
      setCoach("bad","Błąd kamery", String(e && e.message ? e.message : e));
    }
  }

  function stop(){
    running = false;
    try{ camera && camera.stop(); }catch(e){}
    camera = null;
    setStatus("OFF");
    kneeOut.textContent = "—";
    elbowOut.textContent = "—";
    torsoOut.textContent = "—";
    stabOut.textContent = "—";
    kneeWin.push(NaN); elbowWin.push(NaN); torsoWin.push(NaN); confWin.push(NaN);
    ctx.clearRect(0,0,overlay.width, overlay.height);
    setCoach("warn","Zatrzymano","Kliknij “Start kamery”, aby wrócić do LIVE.");
  }

  btnStart.addEventListener("click", start);
  btnStop.addEventListener("click", stop);

  // PWA SW register
  if("serviceWorker" in navigator){
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(()=>{});
    });
  }

})();
</script>
</body>
</html>
